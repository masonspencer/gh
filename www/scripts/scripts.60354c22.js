"use strict";angular.module("workspaceApp",["ngAnimate","ngCookies","ngMessages","ngResource","ngRoute","ngSanitize","ngTouch","firebase","firebase.ref","firebase.auth","ionic","angularMoment","ngLodash"]),angular.module("workspaceApp").controller("MainCtrl",["$scope","Ref","$firebaseArray","$timeout",function(a,b,c,d){a.products=c(b.child("products"))}]),angular.module("firebase.config",[]).constant("FBURL","https://blistering-torch-3665.firebaseio.com").constant("SIMPLE_LOGIN_PROVIDERS",["password","facebook","google","twitter","github"]).constant("loginRedirectPath","/login"),angular.module("firebase.ref",["firebase","firebase.config"]).factory("Ref",["$window","FBURL",function(a,b){return new a.Firebase(b)}]),angular.module("workspaceApp").controller("ChatCtrl",["$scope","Ref","user","$firebaseObject","$firebaseArray","$timeout","Firebase",function(a,b,c,d,e,f,g){var h=b.getAuth(),i="",j=new g("https://blistering-torch-3665.firebaseio.com"),k=new g.util.NormalizedCollection([j.child("/profile/"+h.uid+"/conversations"),"usersConversations"],j.child("/conversations"));k=k.select("usersConversations.$key",{key:"conversations.$value",alias:"conversation"});var l=k.ref();l.on("value",function(b){a.conversations=b.val()}),a.userName=[],a.userGravatar=[],a.getUser=function(b,c){for(i=0;i<b.length;i++)if(b[i]===h.uid);else{var d=new g("https://blistering-torch-3665.firebaseio.com/profile/"+b[i]);d.on("value",function(b){a.userName[c]=b.val().userName,a.userGravatar[c]=b.val().gravatar})}},a.getLastMessage=function(a){var b=Object.keys(a)[Object.keys(a).length-1];return a[b].body}}]),angular.module("workspaceApp").controller("ChatSingleCtrl",["$scope","Ref","user","$routeParams","$firebaseObject","$firebaseArray","$timeout",function(a,b,c,d,e,f,g){function h(b){a.err=b,g(function(){a.err=null},5e3)}var i=d;a.conversation=f(b.child("conversations/"+i.conversationId+"/messages")),a.conversation.$loaded()["catch"](h),a.addConversation=function(b){b&&a.conversation.$add({author:c.uid,body:b,time:Date.now()})["catch"](h)},a.remove=function(b){b.author===c.uid?a.conversation.$remove(b):h("You cant remove that")}}]),angular.module("workspaceApp").controller("listItemCtrl",["$scope","Ref","$firebaseArray","$timeout",function(a,b,c,d){a.geerItems=c(b.child("products"));var e=b.getAuth();a.addItem=function(b){b&&a.geerItems.$add({name:b.name,owner:e.uid,price:b.price,description:b.description,tags:b.tags})["catch"](alert)}}]),angular.module("workspaceApp").filter("reverse",function(){return function(a){return angular.isArray(a)?a.slice().reverse():[]}}),function(){angular.module("firebase.auth",["firebase","firebase.ref"]).factory("Auth",["$firebaseAuth","Ref",function(a,b){return a(b)}])}(),angular.module("workspaceApp").controller("LoginCtrl",["$scope","Auth","$location","$q","Ref","$firebaseArray","$timeout","$ionicPopup","Firebase",function(a,b,c,d,e,f,g,h,i){function j(){c.path("/account")}function k(b){a.err=b}a.oauthLogin=function(c){a.err=null,b.$authWithOAuthPopup(c,{rememberMe:!0}).then(j,k)},a.anonymousLogin=function(){a.err=null,b.$authAnonymously({rememberMe:!0}).then(j,k)},a.passwordLogin=function(c,d){c?d?(a.err=null,b.$authWithPassword({email:c,password:d},{rememberMe:!0}).then(j,k)):(a.err="Please enter a password.",h.alert({title:"Password Empty",template:"Please enter a password"})):(a.err="Please enter an email.",h.alert({title:"Email Invalid",template:"Please enter a valid email."}))},a.createAccount=function(c,d,e,f,g,l,m){function n(a){var b=new i("https://blistering-torch-3665.firebaseio.com/profile/"+a.uid);b.set({email:c,gravatar:a.password.profileImageURL,provider:a.provider,firstName:f,lastName:g,userName:l})}a.err=null,c?d?d!==e?(a.err="Passwords do not match.",h.alert({title:"Password Confirmation Invalid",template:"Passwords do not match."})):f?g?l?m?b.$createUser({email:c,password:d}).then(function(){return b.$authWithPassword({email:c,password:d},{rememberMe:!0})}).then(function(a){return console.log(a.uid),n(a)}).then(j,k):(a.err="Please accept the Terms and Conditions.",h.alert({title:"Terms and Conditions",template:"Please read and accept the Terms and Conditions"})):(a.err="Please enter a user name.",h.alert({title:"Username Empty",template:"Please enter a user name."})):(a.err="Please enter a last name.",h.alert({title:"Last Name Empty",template:"Please enter a last name."})):(a.err="Please enter a first name.",h.alert({title:"Firstname Empty",template:"Please enter a first name."})):(a.err="Please enter a password.",h.alert({title:"Password Empty",template:"Please enter a password"})):(a.err="Please enter an email.",h.alert({title:"Email Invalid",template:"Please enter a valid email."}))}}]),angular.module("workspaceApp").controller("AccountCtrl",["$scope","user","Auth","Ref","$firebaseObject","$timeout",function(a,b,c,d,e,f){function g(a){i(a,"danger")}function h(a){i(a,"success")}function i(b,c){var d={text:b+"",type:c};a.messages.unshift(d),f(function(){a.messages.splice(a.messages.indexOf(d),1)},1e4)}a.user=b,a.logout=function(){c.$unauth()},a.messages=[];var j=e(d.child("users/"+b.uid));j.$bindTo(a,"profile"),a.changePassword=function(b,d,e){a.err=null,b&&d?d!==e?g("Passwords do not match"):c.$changePassword({email:j.email,oldPassword:b,newPassword:d}).then(function(){h("Password changed")},g):g("Please enter all fields")},a.changeEmail=function(b,d){a.err=null,c.$changeEmail({password:b,newEmail:d,oldEmail:j.email}).then(function(){j.email=d,j.$save(),h("Email changed")})["catch"](g)}}]),angular.module("workspaceApp").directive("ngShowAuth",["Auth","$timeout",function(a,b){return{restrict:"A",link:function(c,d){function e(){b(function(){d.toggleClass("ng-cloak",!a.$getAuth())},0)}d.addClass("ng-cloak"),a.$onAuth(e),e()}}}]),angular.module("workspaceApp").directive("ngHideAuth",["Auth","$timeout",function(a,b){return{restrict:"A",link:function(c,d){function e(){b(function(){d.toggleClass("ng-cloak",!!a.$getAuth())},0)}d.addClass("ng-cloak"),a.$onAuth(e),e()}}}]),angular.module("workspaceApp").config(["$routeProvider","SECURED_ROUTES",function(a,b){a.whenAuthenticated=function(c,d){return d.resolve=d.resolve||{},d.resolve.user=["Auth",function(a){return a.$requireAuth()}],a.when(c,d),b[c]=!0,a}}]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).whenAuthenticated("/chat",{templateUrl:"views/chat.html",controller:"ChatCtrl"}).whenAuthenticated("/chatSingle/:conversationId",{templateUrl:"views/chatSingle.html",controller:"ChatSingleCtrl"}).when("/listItem",{templateUrl:"views/listItem.html",controller:"listItemCtrl"}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl"}).whenAuthenticated("/account",{templateUrl:"views/account.html",controller:"AccountCtrl"}).when("/product/:itemID",{templateUrl:"views/product.html",controller:"ProductCtrl"}).otherwise({redirectTo:"/"})}]).run(["$rootScope","$location","Auth","SECURED_ROUTES","loginRedirectPath",function(a,b,c,d,e){function f(a){!a&&g(b.path())&&b.path(e)}function g(a){return d.hasOwnProperty(a)}c.$onAuth(f),a.$on("$routeChangeError",function(a,c,d,f){"AUTH_REQUIRED"===f&&b.path(e)})}]).constant("SECURED_ROUTES",{}),angular.module("workspaceApp").controller("ProductCtrl",["$scope","Ref","$routeParams","$firebaseArray","$timeout","Firebase","$location",function(a,b,c,d,e,f,g){var h=c.itemID;console.log(h);var i=b.getAuth(),j=d(b.child("conversations")),k=d(b.child("products"));k.$loaded().then(function(b){a.product=b.$getRecord(h)})["catch"](function(a){console.log("Error:",a)}),a.newConversation=function(){j.$add({productRef:h,members:[a.product.owner,i.uid]}).then(function(b){var c=b.key();console.log("added record with id "+c),j.$indexFor(c);var d=new f("https://blistering-torch-3665.firebaseio.com/profile/"+i.uid+"/conversations/"),e={};e[c]=!0,d.update(e);var h=new f("https://blistering-torch-3665.firebaseio.com/profile/"+a.product.owner+"/conversations/"),k={};k[c]=!0,h.update(k),g.path("/chatSingle/"+c)})}}]);